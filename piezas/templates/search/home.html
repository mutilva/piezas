{% extends "layout.html" %}

{% load i18n %}

{% block title %}
    {% trans 'Homepage' %} | {{ block.super }}
{% endblock %}

{% block extrahead %}
<style type="text/css">
    .delete-row {
        margin-left:5px;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
    <ul class="breadcrumb">
        <li>
            <a href="{{ homepage_url }}">{% trans 'Home' %}</a>
            <span class="divider">/</span>
        </li>
        <li class="active">{% trans 'Search pieces' %}</li>
    </ul>
{% endblock %}

{% block headertext %}
    {% trans "Search pieces" %}
{% endblock %}

{% block content %}
    <div class="row-fluid">
        <div class="span12 register_form">
   <div class="alert alert-error" id="error_show" style="display:none;">
{% trans "There have been errors in your search. Please correct them and retry" %}
   </div>

			<form id="search_pieces_form" action="." method="post" class="form-horizontal" enctype="multipart/form-data">
				{% csrf_token %}
				<p>{% trans "Please enter the criteria for the pieces you want to search" %}</p>
				{% include "partials/form_fields.html" %}

				{{ formset.management_form }}
			 	<h4>{% trans "Pieces to search" %}</h4>

				<div class="responsible-table">
					<table class="table" id="id_searchitemrequest_table">
						<thead><tr>
							<th>{% trans "Category" %}</th>
							<th>{% trans "Piece" %}</th>
							<th>{% trans "Comments" %}</th>
							<th>{% trans "Questions" %}</th>
							<th>{% trans "Photo" %}</th>
							<th>{% trans "Quantity" %}</th>
						</thead>
						<tbody>
							{% for item_form in formset.forms %}
							<tr id="{{ item_form.prefix }}-row">
								<td>{{item_form.category}}
                {% block errors %}
                    {% for error in item_form.category.errors %}
                        <span class="error-block"><i class="icon-exclamation-sign">
</i> {{ error }}</span>
                    {% endfor %}
                {% endblock %}
</td>
								<td>
								{% for fld in item_form.hidden_fields %}{{ fld }}{% endfor %}
				                            	{% if item_form.instance.pk %}{{ item_form.DELETE }}{% endif %}
								{{item_form.piece}}
                {% block errors1 %}
                    {% for error in item_form.piece.errors %}
                        <span class="error-block"><i class="icon-exclamation-sign">
</i> {{ error }}</span>
                    {% endfor %}
                {% endblock %}

								</td>
								<td>{{item_form.comments}}</td>
								<td><buttton type="button" class="toggle_questions btn">{% trans "Show/hide questions" %}</button></td>
								<td>{{item_form.picture}}</td>
								<td>{{item_form.quantity}}</td>
							</tr>
							<tr><td colspan="6" style='border:0px;'><div class="questions" style="display:none;">{% trans "No questions for this product" %}</div></td></tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				<div class="span12 form-actions">
					<button type="submit" class="btn btn-primary btn-large span4">
					{% trans "Confirm search request" %}
					</button>
					<span class="span8"></span>
				</div>
			</form>
        </div>
    </div>

<script type="text/javascript">
$(document).ready(function()
{
	$("#search_pieces_form").submit(function()
	{
		$("#error_show").html("");
		$("#error_show").hide();
		var $form = $(this);
		$.ajax({
			type: 'POST',
	    		url: $form.action,
    			data: $form.serialize(),
    			success: function(data) {
				if (data.result)
				{
					// redirect
					location.href='{% url 'search:placesearchrequest' %}';
				}
				else
				{
console.log(data);
					// errors
					$("#error_show").html(data.error_message);
					$("#error_show").show();
				}
    			}
		});
		return false;
	});

	function fill_field(current_parent, current_child, category_value, product_value)
	{
		var current_id = $(current_child).id;
		if (!category_value || category_value=='')
		{
                        options = '<option value="">---------<'+'/option>';
			$(current_child).html(options);
			$(this).html(options);
			$("#"+current_id+' option:first').attr('selected', 'selected');
			$(current_child).trigger('change');
                        return;
		}
                $.getJSON("/chaining/filter/catalogue/Product/categories/"+category_value+"/", function(j){
                	var options = '<option value="">---------<'+'/option>';
                        for (var i = 0; i < j.length; i++) {
                            options += '<option value="' + j[i].value + '">' + j[i].display + '<'+'/option>';
                        }
                        var width = $(current_child).outerWidth();
                        $(current_child).html(options);
                        if (navigator.appVersion.indexOf("MSIE") != -1)
                            $(current_child).width(width + 'px');
                        $('#'+current_id+' option:first').attr('selected', 'selected');
                        var auto_choose = false;
                        if(product_value){
                            $('#'+current_id+' option[value="'+ product_value +'"]').attr('selected', 'selected');
                        }
                        if(auto_choose && j.length == 1){
                            $('#'+current_id+' option[value="'+ j[0].value +'"]').attr('selected', 'selected');
                        }
                        $(current_child).trigger('change');
		})

	}
	$("select.piece").change(function()
	{
		var product_value = $(this).val();
                var next_row = $(this).parent().parent('tr').next();
                var current_cell = $(next_row).children()[0];
                var questions_container = $(current_cell).find("div.questions")[0];
		if (product_value)
		{
	                $.getJSON("/catalogue/productquestions/"+product_value+"/", function(data){
				if (data.length>0)
				{
					var final_html = "<table class='table span9'>";
					for (var i in data)
					{
						current_item = data[i];
						if (current_item.type=='boolean')
						{
							final_html += "<tr><th style='border-top:0px;'>"+current_item.text+"</th>";
							final_html+="<td style='border-top:0px;'><input type='checkbox' id='question_"+current_item.id+"' name='question_"+current_item.id+"' /></td>";
						}
						else if (current_item.type=='text')
						{

							final_html += "<tr><th style='border-top:0px;'>"+current_item.text+"</th>";
							final_html+="<td style='border-top:0px;'><input type='text' id='question_"+current_item.id+"' name='question_"+current_item.id+"' size=50 maxlength=255 /></td>";
						}
						else
						{
							// foto, usar el campo principal
							final_html+="<tr><td style='border-top:0px;'>{% trans "It's mandatory to attach a picture" %}</td>";
						}
						final_html += "</tr>";
					}
					final_html += "</table>";
					$(questions_container).html(final_html);
				}
				else
				{
					// no questions
					$(questions_container).html("{% trans "No questions for this product" %}");
				}
			});
		}
		else
		{
			// no questions
			$(questions_container).html("{% trans "No questions for this product" %}");
		}
	});

	$("select.category").change(function(){
		var category_value = $(this).val();
		
		var related_product = $(this).parent().parent().find("select.piece");
		if (related_product.length>0)
		{
			product_value = '';
			var current_select = related_product[0];
			var product_value = $(current_select).val();
                    	fill_field(this, current_select, category_value, product_value);
		}
	})

	$(".toggle_questions").click(function()
	{
		var next_row = $(this).parent().parent('tr').next();
		var current_cell = $(next_row).children()[0];
		var questions = $(current_cell).find("div.questions")[0];
		$(questions).toggle("fast");
	});

	$("select.piece").trigger("change");
});
</script>

{% endblock content %}

